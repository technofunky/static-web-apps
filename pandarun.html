<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panda Runner ‚Äî Offline Game with Users & Rockets</title>
  <style>
    :root{--bg:#f4f8ff;--ground:#dfe7f3;--text:#222}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
    .layout{display:flex;flex-direction:row;gap:14px;padding:18px}
    .sidebar{width:260px;background:#fff;border:1px solid #d0d7e6;padding:12px;border-radius:8px;height:fit-content;box-shadow:0 4px 16px rgba(30,40,60,.08)}
    canvas{background:linear-gradient(#dff1ff, #f4f8ff);border-radius:8px;box-shadow:0 6px 22px rgba(20,30,60,.08);max-width:100%;height:auto;}
    .btn{background:#fff;border:1px solid #d0d7e6;padding:6px 10px;border-radius:8px;cursor:pointer;user-select:none;-webkit-user-select:none;touch-action:manipulation;transition:transform 0.1s ease, background 0.2s ease;}
    .btn:active{transform:scale(0.95);}
    .input{width:100%;padding:6px 8px;border-radius:6px;border:1px solid #cdd5e0;margin-bottom:8px}
    h3{margin:8px 0}
    .score-item{font-size:14px;padding:4px 0;border-bottom:1px solid #eee}
    .rocket-display{background:#e8f4ff;border:1px solid #b8d9f5;padding:8px;border-radius:6px;margin-bottom:12px;font-weight:600;color:#1a5f8a}
    
    /* Mobile responsive styles */
    @media (max-width: 768px) {
      .layout{flex-direction:column;padding:10px;}
      .sidebar{width:100%;margin-bottom:12px;}
      canvas{width:100%;height:auto;}
      .btn{padding:10px 14px;font-size:14px;}
    }
  </style>
</head>
<body>
  <div class="layout">

    <!-- SIDEBAR FOR USER SCORES -->
    <div class="sidebar">
      <h3>Players</h3>
      <input id="username" class="input" placeholder="Enter username" />
      <button id="addUser" class="btn" style="width:100%; margin-bottom:10px;">Select / Add User</button>
      <div id="currentUserBox" style="margin-bottom:12px; font-weight:600;"></div>
      <div id="rocketDisplay" class="rocket-display" style="display:none;">üöÄ Rockets: <span id="rocketCount">0</span></div>

      <h3>Scoreboard</h3>
      <div style="font-size:11px;color:#6b7280;margin-bottom:6px;font-style:italic;">Click a player to select them</div>
      <div id="scoreList"></div>
      
      <div style="margin-top:12px;display:flex;flex-direction:column;gap:6px;">
        <button id="viewHistory" class="btn" style="font-size:12px;background:#d4edda;border-color:#28a745;">üìä View History</button>
        <button id="editUser" class="btn" style="font-size:12px;background:#fff3cd;border-color:#ffc107;">‚úèÔ∏è Edit User</button>
        <button id="deleteUser" class="btn" style="font-size:12px;background:#f8d7da;border-color:#dc3545;">üóëÔ∏è Delete User</button>
        <button id="resetScores" class="btn" style="font-size:12px;background:#d1ecf1;border-color:#17a2b8;">üîÑ Reset All Scores</button>
        <hr style="margin:8px 0;border:none;border-top:1px solid #e0e0e0;">
        <button id="exportData" class="btn" style="font-size:12px;background:#e8f5e9;border-color:#4caf50;">üíæ Export Data</button>
        <button id="importData" class="btn" style="font-size:12px;background:#fff9c4;border-color:#ffc107;">üì• Import Data</button>
      </div>
    </div>

    <!-- GAME AREA -->
    <div style="flex:1">
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;">
        <button id="restart" class="btn">Restart</button>
        <button id="pause" class="btn">Pause</button>
        <button id="shoot" class="btn">Shoot Rocket üöÄ</button>
        <div>Score: <span id="score">0</span></div>
        <div style="color:#ff5722;font-weight:600;">üöÄ Rockets: <span id="rocketCountGame">0</span></div>
      </div>
      <canvas id="game" width="900" height="260" tabindex="0"></canvas>
      
      <!-- MOBILE TOUCH CONTROLS -->
      <div id="mobileControls" style="display:none;margin-top:12px;gap:10px;justify-content:center;">
        <button id="touchJump" class="btn" style="font-size:20px;padding:12px 24px;background:#4CAF50;color:#fff;border:2px solid #45a049;">‚¨ÜÔ∏è JUMP</button>
        <button id="touchDuck" class="btn" style="font-size:20px;padding:12px 24px;background:#2196F3;color:#fff;border:2px solid #0b7dda;">‚¨áÔ∏è DUCK</button>
        <button id="touchShoot" class="btn" style="font-size:20px;padding:12px 24px;background:#ff5722;color:#fff;border:2px solid #e64a19;">üöÄ ROCKET</button>
      </div>
      
      <div style="font-size:13px;color:#6b7280;margin-top:6px;">
        <strong>Desktop:</strong> Jump: Space/‚Üë ‚Ä¢ Duck: ‚Üì ‚Ä¢ Shoot Rocket: R or button ‚Ä¢ Pause: P<br>
        <strong>Mobile:</strong> Use touch buttons below the game<br>
        <em>Earn 1 rocket for every 100 points! New users start with 5 rockets.</em>
      </div>
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  /* ------------------ USERS & SCOREBOARD -------------------- */
  let users = JSON.parse(localStorage.getItem('panda_users') || '{}');
  let currentUser = null;

  const userInput = document.getElementById('username');
  const addUserBtn = document.getElementById('addUser');
  const scoreList = document.getElementById('scoreList');
  const currentUserBox = document.getElementById('currentUserBox');
  const rocketDisplay = document.getElementById('rocketDisplay');
  const rocketCountSpan = document.getElementById('rocketCount');

  function saveUsers(){ localStorage.setItem('panda_users', JSON.stringify(users)); }

  function updateRocketDisplay(){
    if(currentUser){
      rocketDisplay.style.display = 'block';
      const rocketCount = users[currentUser].rockets || 0;
      rocketCountSpan.textContent = rocketCount;
      document.getElementById('rocketCountGame').textContent = rocketCount;
    } else {
      rocketDisplay.style.display = 'none';
      document.getElementById('rocketCountGame').textContent = '0';
    }
  }

  function selectUser(){
    const name = userInput.value.trim();
    if(!name) return;
    if(!users[name]) users[name] = { scores: [], avg: 0, rockets: 5 };
    // Ensure existing users have rockets property
    if(users[name].rockets === undefined) users[name].rockets = 5;
    currentUser = name;
    currentUserBox.textContent = "Current User: " + name;
    updateScoreboard();
    updateRocketDisplay();
    saveUsers();
  }

  function recordScore(score){
    if(!currentUser) return;
    users[currentUser].scores.push(score);
    const arr = users[currentUser].scores;
    users[currentUser].avg = arr.reduce((a,b)=>a+b,0) / arr.length;
    
    // Rockets are now awarded during gameplay in real-time, not at the end
    
    saveUsers();
    updateScoreboard();
    updateRocketDisplay();
  }

  function awardRocket(){
    if(!currentUser) return;
    users[currentUser].rockets++;
    saveUsers();
    updateRocketDisplay();
    
    // Trigger rocket earned animation
    rocketEarnedAnim.active = true;
    rocketEarnedAnim.frame = 0;
    
    // Play reward sound
    playRocketEarnedSound();
  }

  function playRocketEarnedSound(){
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      // Happy ascending sound
      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
      oscillator.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + 0.2);
      
      gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.25);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.25);
    } catch(e) {
      // Ignore audio errors
    }
  }

  function useRocket(){
    if(!currentUser) return false;
    if(users[currentUser].rockets > 0){
      users[currentUser].rockets--;
      saveUsers();
      updateRocketDisplay();
      return true;
    }
    return false;
  }

  function updateScoreboard(){
    scoreList.innerHTML = '';
    for(const [name, data] of Object.entries(users)){
      const div = document.createElement('div');
      div.className = 'score-item';
      const rockets = data.rockets || 0;
      div.textContent = `${name}: Avg ${data.avg.toFixed(1)} (Games: ${data.scores.length}, üöÄ: ${rockets})`;
      
      // Highlight current user
      if(name === currentUser){
        div.style.background = '#e3f2fd';
        div.style.fontWeight = '600';
      }
      
      // Make clickable to select user
      div.style.cursor = 'pointer';
      div.onclick = () => {
        currentUser = name;
        currentUserBox.textContent = "Current User: " + name;
        userInput.value = name;
        updateScoreboard();
        updateRocketDisplay();
        saveUsers();
      };
      
      // Hover effect
      div.onmouseenter = () => {
        if(name !== currentUser) div.style.background = '#f5f5f5';
      };
      div.onmouseleave = () => {
        if(name !== currentUser) div.style.background = 'transparent';
      };
      
      scoreList.appendChild(div);
    }
  }

  addUserBtn.onclick = selectUser;

  function editUser(){
    if(!currentUser){
      alert('Please select a user first!');
      return;
    }
    
    const newName = prompt(`Edit username for "${currentUser}":`, currentUser);
    if(!newName || !newName.trim()) return;
    
    const trimmedName = newName.trim();
    
    // Check if new name already exists
    if(trimmedName !== currentUser && users[trimmedName]){
      alert('A user with that name already exists!');
      return;
    }
    
    // Rename the user
    if(trimmedName !== currentUser){
      users[trimmedName] = users[currentUser];
      delete users[currentUser];
      currentUser = trimmedName;
      currentUserBox.textContent = "Current User: " + trimmedName;
      userInput.value = trimmedName;
      saveUsers();
      updateScoreboard();
      updateRocketDisplay();
    }
  }

  function deleteUser(){
    if(!currentUser){
      alert('Please select a user first!');
      return;
    }
    
    const confirmDelete = confirm(`Are you sure you want to delete user "${currentUser}"?\n\nThis will remove:\n‚Ä¢ All their scores (${users[currentUser].scores.length} games)\n‚Ä¢ Their ${users[currentUser].rockets} rockets\n\nThis cannot be undone!`);
    
    if(confirmDelete){
      delete users[currentUser];
      currentUser = null;
      currentUserBox.textContent = "";
      userInput.value = "";
      saveUsers();
      updateScoreboard();
      updateRocketDisplay();
    }
  }

  function resetAllScores(){
    const userCount = Object.keys(users).length;
    if(userCount === 0){
      alert('No users to reset!');
      return;
    }
    
    let totalGames = 0;
    for(const user in users){
      totalGames += users[user].scores.length;
    }
    
    const confirmReset = confirm(`Reset all scores for ${userCount} user(s)?\n\nThis will:\n‚Ä¢ Clear all ${totalGames} game scores\n‚Ä¢ Reset all averages to 0\n‚Ä¢ Keep all users and their rockets\n\nThis cannot be undone!`);
    
    if(confirmReset){
      for(const user in users){
        users[user].scores = [];
        users[user].avg = 0;
        // Keep rockets - they earned them!
      }
      saveUsers();
      updateScoreboard();
      alert('All scores have been reset!');
    }
  }

  function viewHistory(){
    if(!currentUser){
      alert('Please select a user first!');
      return;
    }
    
    const userData = users[currentUser];
    const scores = userData.scores;
    
    if(scores.length === 0){
      alert(`${currentUser} has no game history yet!`);
      return;
    }
    
    // Calculate statistics
    const sortedScores = [...scores].sort((a, b) => b - a);
    const highest = sortedScores[0];
    const lowest = sortedScores[sortedScores.length - 1];
    const avg = userData.avg;
    const total = scores.reduce((sum, s) => sum + s, 0);
    
    // Format the last 10 games (most recent)
    const recentGames = scores.slice(-10).reverse();
    const gamesText = recentGames.map((score, i) => 
      `Game ${scores.length - i}: ${score}`
    ).join('\n');
    
    const message = `üìä ${currentUser}'s Game History\n\n` +
                    `Total Games: ${scores.length}\n` +
                    `Average Score: ${avg.toFixed(1)}\n` +
                    `Highest Score: ${highest}\n` +
                    `Lowest Score: ${lowest}\n` +
                    `Total Points: ${total}\n` +
                    `Rockets: ${userData.rockets}\n\n` +
                    `Last ${Math.min(10, scores.length)} Games:\n` +
                    `${gamesText}`;
    
    alert(message);
  }

  function exportData(){
    const userCount = Object.keys(users).length;
    if(userCount === 0){
      alert('No data to export! Add some users and play games first.');
      return;
    }
    
    const dataStr = JSON.stringify(users, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `panda-runner-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    alert(`Exported data for ${userCount} user(s)!`);
  }

  function importData(){
    const confirmImport = confirm('Import data from a backup file?\n\nWarning: This will REPLACE all current data!\n\nMake sure to export your current data first if you want to keep it.');
    
    if(!confirmImport) return;
    
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = (e) => {
      const file = e.target.files[0];
      if(!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const importedData = JSON.parse(event.target.result);
          
          // Validate the data structure
          if(typeof importedData !== 'object' || importedData === null){
            throw new Error('Invalid data format');
          }
          
          // Basic validation - check if it looks like user data
          let validData = true;
          for(const [name, data] of Object.entries(importedData)){
            if(!data.scores || !Array.isArray(data.scores)){
              validData = false;
              break;
            }
          }
          
          if(!validData){
            throw new Error('Data does not appear to be valid Panda Runner user data');
          }
          
          // Import the data
          users = importedData;
          
          // Ensure all users have rockets property
          for(const name in users){
            if(users[name].rockets === undefined){
              users[name].rockets = 5;
            }
          }
          
          currentUser = null;
          currentUserBox.textContent = "";
          userInput.value = "";
          
          saveUsers();
          updateScoreboard();
          updateRocketDisplay();
          
          const userCount = Object.keys(users).length;
          alert(`Successfully imported data for ${userCount} user(s)!`);
          
        } catch(error) {
          alert('Error importing data: ' + error.message + '\n\nPlease make sure you selected a valid Panda Runner backup file.');
        }
      };
      
      reader.readAsText(file);
    };
    
    input.click();
  }

  document.getElementById('viewHistory').onclick = viewHistory;
  document.getElementById('editUser').onclick = editUser;
  document.getElementById('deleteUser').onclick = deleteUser;
  document.getElementById('resetScores').onclick = resetAllScores;
  document.getElementById('exportData').onclick = exportData;
  document.getElementById('importData').onclick = importData;

  /* ------------------ GAME VARIABLES -------------------- */
  let speed = 6;
  let score = 0;
  let running = true;
  let obstacles = [];
  let clouds = [];
  let rockets = [];
  let frame = 0;
  let scoreRecorded = false; // Track if we've recorded the score for this game
  let lastRocketMilestone = 0; // Track last score milestone for rocket awards

  let rocketPower = 1; // Obstacles get tougher
  
  // Animation for out-of-rockets notification
  let outOfRocketsAnim = { active: false, frame: 0, duration: 60 }; // 1 second at 60fps
  
  // Animation for rocket earned notification
  let rocketEarnedAnim = { active: false, frame: 0, duration: 90 }; // 1.5 seconds

  const panda = { x:80, y:H-62, w:48, h:48, vy:0, gravity:0.9, jumpForce:-14, onGround:true, duck:false };

  function reset(){
    // Don't record score again if already recorded
    speed = 6; score = 0; frame = 0;
    obstacles = []; clouds = []; rockets = [];
    panda.y = H-62; panda.vy = 0; panda.onGround = true;
    rocketPower = 1;
    running = true;
    scoreRecorded = false; // Reset the flag for new game
    lastRocketMilestone = 0; // Reset rocket milestone
    updateHUD();
  }

  function updateHUD(){ document.getElementById('score').textContent = Math.floor(score); }

  /* ------------------ OBSTACLES -------------------- */
  function spawnObstacle(){
    const h = 30 + Math.random()*60;
    const w = 20 + Math.random()*40;
    const toughness = Math.ceil(rocketPower); // Higher ‚Üí harder to destroy
    obstacles.push({x:W+20, y:H-40-(h-24), w, h, hp: toughness});
  }

  function spawnCloud(){ clouds.push({x:W+10, y:20+Math.random()*60, w:60+Math.random()*80}); }

  /* ------------------ ROCKETS -------------------- */
  function playNoRocketSound(){
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      // Buzz sound
      oscillator.type = 'sawtooth';
      oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
      oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.1);
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.15);
    } catch(e) {
      // Ignore audio errors
    }
  }
  
  function shootRocket(){
    if(!currentUser){
      alert('Please select a user first!');
      return;
    }
    if(!useRocket()){
      // No rockets left - trigger animation and sound
      outOfRocketsAnim.active = true;
      outOfRocketsAnim.frame = 0;
      playNoRocketSound();
      return;
    }
    rockets.push({x:panda.x + panda.w, y:panda.y + panda.h/2 - 4, w:16, h:6, speed:10});
  }

  document.getElementById('shoot').onclick = shootRocket;

  /* ------------------ COLLISON -------------------- */
  function rectsCollide(a,b){
    return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
  }

  /* ------------------ DRAW PANDA -------------------- */
  function drawPanda(x,y,w,h,duck){
    const headR = w*0.45;
    ctx.fillStyle = 'rgba(0,0,0,0.06)';
    ctx.beginPath(); ctx.ellipse(x+w*0.45, y+h+8, w*0.48, 8, 0, 0, Math.PI*2); ctx.fill();

    ctx.fillStyle = '#fff'; ctx.fillRect(x+(w*0.05), y+headR*0.6, w*0.9, h*0.6);
    ctx.fillStyle = '#111';
    ctx.beginPath(); ctx.arc(x+headR*0.45, y+headR*0.12, headR*0.18,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(x+w-headR*0.45, y+headR*0.12, headR*0.18,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(x+headR*0.45-6, y+headR*0.45, headR*0.16, headR*0.12,-0.2,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(x+w-headR*0.45+6, y+headR*0.45, headR*0.16, headR*0.12,0.2,0,Math.PI*2); ctx.fill();

    ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(x+w*0.45,y+headR*0.45,headR*0.6,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = '#111'; ctx.beginPath(); ctx.arc(x+headR*0.45-6,y+headR*0.45,3,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(x+w-headR*0.45+6,y+headR*0.45,3,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(x+w*0.45,y+headR*0.6,4,0,Math.PI*2); ctx.fill();

    ctx.fillStyle='#111';
    if(!duck){ ctx.fillRect(x+6,y+h-6,12,8); ctx.fillRect(x+w-18,y+h-6,12,8); }
    else ctx.fillRect(x+8,y+h-4,10,6);
  }

  /* ------------------ GAME LOOP -------------------- */
  function update(){
    if(!running) return;
    frame++;

    if(frame % 300 === 0){ speed += 0.6; rocketPower += 0.4; }

    if(frame % 140 === 0) spawnCloud();
    clouds.forEach(c => c.x -= speed*0.3);
    clouds = clouds.filter(c => c.x + c.w > -50);

    if(frame % Math.max(40,120-Math.floor(score/8)) === 0) spawnObstacle();
    obstacles.forEach(o => o.x -= speed);
    obstacles = obstacles.filter(o => o.x + o.w > -20);

    rockets.forEach(r => r.x += r.speed);
    rockets = rockets.filter(r => r.x < W+50);

    panda.vy += panda.gravity;
    panda.y += panda.vy;
    if(panda.y >= H-62){ panda.y=H-62; panda.vy=0; panda.onGround=true; }
    else panda.onGround=false;

    // Rocket-obstacle collision
    for(let i = rockets.length - 1; i >= 0; i--){
      const r = rockets[i];
      for(let j = obstacles.length - 1; j >= 0; j--){
        const o = obstacles[j];
        if(rectsCollide(r,o)){
          o.hp -= 1;
          // Remove the rocket immediately after hit
          rockets.splice(i, 1);
          break; // Rocket can only hit one obstacle
        }
      }
    }
    
    // Remove destroyed obstacles
    obstacles = obstacles.filter(o => o.hp > 0);

    const pRect = {x:panda.x, y:panda.y, w:panda.w, h:panda.h*(panda.duck?0.6:1)};
    for(const ob of obstacles){ 
      if(rectsCollide(pRect,ob)){ 
        running=false; 
        if(!scoreRecorded && currentUser){
          recordScore(Math.floor(score));
          scoreRecorded = true;
        }
        break; 
      }
    }

    score += 0.1 * speed;
    updateHUD();
    
    // Award rockets in real-time when crossing 100-point milestones
    if(currentUser){
      const currentMilestone = Math.floor(score / 100);
      
      // Check if we've crossed into a new milestone
      if(currentMilestone > lastRocketMilestone){
        // Player crossed a 100-point milestone, award a rocket!
        awardRocket();
        lastRocketMilestone = currentMilestone; // Store the milestone number (0, 1, 2, 3...)
      }
    }
    
    // Update out-of-rockets animation
    if(outOfRocketsAnim.active){
      outOfRocketsAnim.frame++;
      if(outOfRocketsAnim.frame >= outOfRocketsAnim.duration){
        outOfRocketsAnim.active = false;
        outOfRocketsAnim.frame = 0;
      }
    }
    
    // Update rocket earned animation
    if(rocketEarnedAnim.active){
      rocketEarnedAnim.frame++;
      if(rocketEarnedAnim.frame >= rocketEarnedAnim.duration){
        rocketEarnedAnim.active = false;
        rocketEarnedAnim.frame = 0;
      }
    }
  }

  function draw(){
    ctx.clearRect(0,0,W,H);
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,'#eaf6ff'); g.addColorStop(1,'#f4f8ff');
    ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

    ctx.fillStyle='rgba(255,255,255,0.95)';
    clouds.forEach(c=>{
      ctx.beginPath(); ctx.ellipse(c.x,c.y,c.w*0.7,20,0,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(c.x+20,c.y+6,c.w*0.5,14,0,0,Math.PI*2); ctx.fill();
    });

    ctx.fillStyle='#e6eef9'; ctx.fillRect(0,H-36,W,36);

    obstacles.forEach(o=>{
      ctx.fillStyle = o.hp>2?'#1f6d29':'#2d8a36';
      ctx.fillRect(o.x,o.y,o.w,o.h);
      // Draw HP indicator on tough obstacles
      if(o.hp > 1){
        ctx.fillStyle='#fff';
        ctx.font='10px system-ui';
        ctx.fillText(o.hp, o.x+o.w/2-4, o.y+o.h/2+4);
      }
    });

    // Draw rockets with flame effect
    ctx.fillStyle='#ff4444';
    rockets.forEach(r=> {
      ctx.fillRect(r.x,r.y,r.w,r.h);
      // Flame trail
      ctx.fillStyle='#ffaa44';
      ctx.fillRect(r.x-6, r.y+1, 6, 4);
      ctx.fillStyle='#ff4444';
    });

    drawPanda(panda.x,panda.y,panda.w,panda.h,panda.duck);

    // Draw in-game rocket count
    if(currentUser){
      const rocketCount = users[currentUser].rockets || 0;
      
      // Shake effect when out of rockets animation is active
      let counterX = W-120;
      let counterY = 10;
      if(outOfRocketsAnim.active){
        const progress = outOfRocketsAnim.frame / outOfRocketsAnim.duration;
        const shakeAmount = 4 * (1 - progress);
        counterX += (Math.random() - 0.5) * shakeAmount;
        counterY += (Math.random() - 0.5) * shakeAmount;
      }
      
      // Background color changes if no rockets
      if(rocketCount === 0){
        ctx.fillStyle='rgba(255,220,220,0.95)';
      } else {
        ctx.fillStyle='rgba(255,255,255,0.9)';
      }
      ctx.fillRect(counterX, counterY, 110, 36);
      
      // Border color
      if(rocketCount === 0){
        ctx.strokeStyle='#dc2626';
      } else {
        ctx.strokeStyle='#ff5722';
      }
      ctx.lineWidth=2;
      ctx.strokeRect(counterX, counterY, 110, 36);
      
      // Text
      ctx.fillStyle = rocketCount === 0 ? '#dc2626' : '#ff5722';
      ctx.font='bold 18px system-ui';
      ctx.fillText(`üöÄ ${rocketCount}`, counterX + 10, counterY + 24);
      
      // Progress bar to next rocket (below the counter)
      const progressToNext = (score % 100) / 100;
      const nextMilestone = (Math.floor(score / 100) + 1) * 100;
      
      // Progress bar background
      ctx.fillStyle='rgba(200,200,200,0.5)';
      ctx.fillRect(counterX, counterY + 40, 110, 8);
      
      // Progress bar fill
      ctx.fillStyle='#4CAF50';
      ctx.fillRect(counterX, counterY + 40, 110 * progressToNext, 8);
      
      // Border
      ctx.strokeStyle='rgba(100,100,100,0.3)';
      ctx.lineWidth=1;
      ctx.strokeRect(counterX, counterY + 40, 110, 8);
      
      // Text showing next milestone
      ctx.fillStyle='#555';
      ctx.font='10px system-ui';
      ctx.fillText(`Next: ${nextMilestone}`, counterX + 2, counterY + 58);
    }

    // Draw out-of-rockets animation
    if(outOfRocketsAnim.active){
      const progress = outOfRocketsAnim.frame / outOfRocketsAnim.duration;
      const opacity = 1 - progress; // Fade out
      
      // Shake effect
      const shakeAmount = 8 * (1 - progress);
      const shakeX = (Math.random() - 0.5) * shakeAmount;
      const shakeY = (Math.random() - 0.5) * shakeAmount;
      
      // Pulse/scale effect
      const scale = 1 + Math.sin(progress * Math.PI) * 0.3;
      
      ctx.save();
      ctx.translate(W/2 + shakeX, H/2 - 60 + shakeY);
      ctx.scale(scale, scale);
      
      // Shadow/glow effect
      ctx.shadowColor = 'rgba(220, 38, 38, ' + (opacity * 0.8) + ')';
      ctx.shadowBlur = 20;
      
      // Background box
      ctx.fillStyle = 'rgba(220, 38, 38, ' + (opacity * 0.9) + ')';
      ctx.fillRect(-140, -35, 280, 70);
      
      // Border
      ctx.strokeStyle = 'rgba(255, 255, 255, ' + opacity + ')';
      ctx.lineWidth = 3;
      ctx.strokeRect(-140, -35, 280, 70);
      
      // Text
      ctx.fillStyle = 'rgba(255, 255, 255, ' + opacity + ')';
      ctx.font = 'bold 32px system-ui';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('OUT OF ROCKETS!', 0, -5);
      
      // Subtext
      ctx.font = '16px system-ui';
      ctx.fillStyle = 'rgba(255, 255, 255, ' + (opacity * 0.8) + ')';
      ctx.fillText('Earn more by scoring points', 0, 20);
      
      ctx.restore();
      ctx.shadowBlur = 0;
      ctx.textAlign = 'start';
      ctx.textBaseline = 'alphabetic';
    }

    // Draw rocket earned animation
    if(rocketEarnedAnim.active){
      const progress = rocketEarnedAnim.frame / rocketEarnedAnim.duration;
      const opacity = 1 - progress; // Fade out
      
      // Float up effect
      const floatY = -progress * 50; // Float upward
      
      // Bounce/scale effect - starts big, settles down
      const bounceScale = 1 + Math.max(0, 0.5 - progress) * 2;
      
      ctx.save();
      ctx.translate(W/2, H/2 - 40 + floatY);
      ctx.scale(bounceScale, bounceScale);
      
      // Glow effect
      ctx.shadowColor = 'rgba(255, 152, 0, ' + (opacity * 0.8) + ')';
      ctx.shadowBlur = 30;
      
      // Background box with green theme
      ctx.fillStyle = 'rgba(34, 197, 94, ' + (opacity * 0.95) + ')';
      ctx.fillRect(-140, -35, 280, 70);
      
      // Gold border
      ctx.strokeStyle = 'rgba(255, 215, 0, ' + opacity + ')';
      ctx.lineWidth = 4;
      ctx.strokeRect(-140, -35, 280, 70);
      
      // Text
      ctx.fillStyle = 'rgba(255, 255, 255, ' + opacity + ')';
      ctx.font = 'bold 36px system-ui';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('üöÄ +1 ROCKET!', 0, -5);
      
      // Subtext
      ctx.font = '16px system-ui';
      ctx.fillStyle = 'rgba(255, 255, 255, ' + (opacity * 0.9) + ')';
      ctx.fillText('100 points milestone!', 0, 20);
      
      // Sparkle effects
      if(progress < 0.5){
        for(let i = 0; i < 8; i++){
          const angle = (i / 8) * Math.PI * 2 + progress * Math.PI * 4;
          const dist = 80 + progress * 40;
          const sparkleX = Math.cos(angle) * dist;
          const sparkleY = Math.sin(angle) * dist;
          const sparkleOpacity = (1 - progress * 2) * opacity;
          
          ctx.fillStyle = 'rgba(255, 215, 0, ' + sparkleOpacity + ')';
          ctx.beginPath();
          ctx.arc(sparkleX, sparkleY, 4, 0, Math.PI * 2);
          ctx.fill();
        }
      }
      
      ctx.restore();
      ctx.shadowBlur = 0;
      ctx.textAlign = 'start';
      ctx.textBaseline = 'alphabetic';
    }

    if(!running){
      ctx.fillStyle='rgba(20,30,40,0.7)'; ctx.fillRect(0,0,W,H);
      ctx.fillStyle='#fff'; ctx.font='28px system-ui'; ctx.textAlign='center';
      ctx.fillText('Game Over',W/2,H/2-6);
      ctx.font='16px system-ui'; ctx.fillText('Press Restart or Space',W/2,H/2+20);
      ctx.textAlign='start';
    }
  }

  function loop(){ update(); draw(); requestAnimationFrame(loop); }

  function jump(){
    if(!running){ reset(); return; }
    if(panda.onGround){ panda.vy=panda.jumpForce; panda.onGround=false; }
  }
  function duckStart(){ panda.duck=true; panda.h=34; }
  function duckEnd(){ panda.duck=false; panda.h=48; }

  window.addEventListener('keydown',e=>{
    if(e.code==='Space'||e.code==='ArrowUp'){ e.preventDefault(); jump(); }
    if(e.code==='ArrowDown'){ e.preventDefault(); duckStart(); }
    if(e.key==='r'||e.key==='R') shootRocket();
    if(e.key==='p'||e.key==='P'){ running=!running; document.getElementById('pause').textContent = running?'Pause':'Resume'; }
  });

  window.addEventListener('keyup',e=>{
    if(e.code==='ArrowDown') duckEnd();
    if(e.code==='Space' && !running) reset();
  });

  document.getElementById('restart').onclick = reset;
  document.getElementById('pause').onclick = ()=>{ running=!running; document.getElementById('pause').textContent = running?'Pause':'Resume'; };

  /* ------------------ MOBILE DETECTION & CONTROLS -------------------- */
  // Detect mobile/touch device
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   ('ontouchstart' in window) || 
                   (navigator.maxTouchPoints > 0);
  
  // Canvas touch - only enable on desktop for quick tap-to-jump
  if(!isMobile){
    canvas.addEventListener('touchstart',e=>{ e.preventDefault(); jump(); });
  }
  
  // Show mobile control buttons
  if(isMobile){
    const mobileControls = document.getElementById('mobileControls');
    mobileControls.style.display = 'flex';
    
    const touchJump = document.getElementById('touchJump');
    const touchDuck = document.getElementById('touchDuck');
    const touchShoot = document.getElementById('touchShoot');
    
    // Jump button
    touchJump.addEventListener('touchstart', (e) => {
      e.preventDefault();
      jump();
      touchJump.style.transform = 'scale(0.95)';
    });
    
    touchJump.addEventListener('touchend', (e) => {
      e.preventDefault();
      touchJump.style.transform = 'scale(1)';
    });
    
    // Duck button - hold to duck
    touchDuck.addEventListener('touchstart', (e) => {
      e.preventDefault();
      duckStart();
      touchDuck.style.transform = 'scale(0.95)';
      touchDuck.style.background = '#1976D2';
    });
    
    touchDuck.addEventListener('touchend', (e) => {
      e.preventDefault();
      duckEnd();
      touchDuck.style.transform = 'scale(1)';
      touchDuck.style.background = '#2196F3';
    });
    
    touchDuck.addEventListener('touchcancel', (e) => {
      e.preventDefault();
      duckEnd();
      touchDuck.style.transform = 'scale(1)';
      touchDuck.style.background = '#2196F3';
    });
    
    // Shoot button
    touchShoot.addEventListener('touchstart', (e) => {
      e.preventDefault();
      shootRocket();
      touchShoot.style.transform = 'scale(0.95)';
    });
    
    touchShoot.addEventListener('touchend', (e) => {
      e.preventDefault();
      touchShoot.style.transform = 'scale(1)';
    });
    
    // Also support mouse clicks on mobile buttons for testing
    touchJump.onclick = (e) => { e.preventDefault(); jump(); };
    touchDuck.onmousedown = (e) => { e.preventDefault(); duckStart(); touchDuck.style.background = '#1976D2'; };
    touchDuck.onmouseup = (e) => { e.preventDefault(); duckEnd(); touchDuck.style.background = '#2196F3'; };
    touchDuck.onmouseleave = (e) => { e.preventDefault(); duckEnd(); touchDuck.style.background = '#2196F3'; };
    touchShoot.onclick = (e) => { e.preventDefault(); shootRocket(); };
  }

  // Initialize display
  updateScoreboard();
  updateRocketDisplay();

  for(let i=0;i<3;i++) spawnCloud();
  loop();
})();
</script>
</body>
</html>
