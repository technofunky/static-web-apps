<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panda Runner — Offline Game with Users & Rockets</title>
  <style>
    :root{--bg:#f4f8ff;--ground:#dfe7f3;--text:#222}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
    .layout{display:flex;flex-direction:row;gap:14px;padding:18px}
    .sidebar{width:260px;background:#fff;border:1px solid #d0d7e6;padding:12px;border-radius:8px;height:fit-content;box-shadow:0 4px 16px rgba(30,40,60,.08)}
    canvas{background:linear-gradient(#dff1ff, #f4f8ff);border-radius:8px;box-shadow:0 6px 22px rgba(20,30,60,.08)}
    .btn{background:#fff;border:1px solid #d0d7e6;padding:6px 10px;border-radius:8px;cursor:pointer}
    .input{width:100%;padding:6px 8px;border-radius:6px;border:1px solid #cdd5e0;margin-bottom:8px}
    h3{margin:8px 0}
    .score-item{font-size:14px;padding:4px 0;border-bottom:1px solid #eee}
  </style>
</head>
<body>
  <div class="layout">

    <!-- SIDEBAR FOR USER SCORES -->
    <div class="sidebar">
      <h3>Players</h3>
      <input id="username" class="input" placeholder="Enter username" />
      <button id="addUser" class="btn" style="width:100%; margin-bottom:10px;">Select / Add User</button>
      <div id="currentUserBox" style="margin-bottom:12px; font-weight:600;"></div>

      <h3>Scoreboard</h3>
      <div id="scoreList"></div>
    </div>

    <!-- GAME AREA -->
    <div style="flex:1">
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;">
        <button id="restart" class="btn">Restart</button>
        <button id="pause" class="btn">Pause</button>
        <button id="shoot" class="btn">Shoot Rocket</button>
        <div>Score: <span id="score">0</span></div>
      </div>
      <canvas id="game" width="900" height="260" tabindex="0"></canvas>
      <div style="font-size:13px;color:#6b7280;margin-top:6px;">Jump: Space/↑ • Duck: ↓ • Shoot Rocket: R or button • Pause: P</div>
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  /* ------------------ USERS & SCOREBOARD -------------------- */
  let users = JSON.parse(localStorage.getItem('panda_users') || '{}');
  let currentUser = null;

  const userInput = document.getElementById('username');
  const addUserBtn = document.getElementById('addUser');
  const scoreList = document.getElementById('scoreList');
  const currentUserBox = document.getElementById('currentUserBox');

  function saveUsers(){ localStorage.setItem('panda_users', JSON.stringify(users)); }

  function selectUser(){
    const name = userInput.value.trim();
    if(!name) return;
    if(!users[name]) users[name] = { scores: [], avg: 0 };
    currentUser = name;
    currentUserBox.textContent = "Current User: " + name;
    updateScoreboard();
    saveUsers();
  }

  function recordScore(score){
    if(!currentUser) return;
    users[currentUser].scores.push(score);
    const arr = users[currentUser].scores;
    users[currentUser].avg = arr.reduce((a,b)=>a+b,0) / arr.length;
    saveUsers();
    updateScoreboard();
  }

  function updateScoreboard(){
    scoreList.innerHTML = '';
    for(const [name, data] of Object.entries(users)){
      const div = document.createElement('div');
      div.className = 'score-item';
      div.textContent = `${name}: Avg ${data.avg.toFixed(1)} (Games: ${data.scores.length})`;
      scoreList.appendChild(div);
    }
  }

  addUserBtn.onclick = selectUser;

  /* ------------------ GAME VARIABLES -------------------- */
  let speed = 6;
  let score = 0;
  let running = true;
  let obstacles = [];
  let clouds = [];
  let rockets = [];
  let frame = 0;

  let jumpCount = 0; // Track jumps → unlock rocket
  let rocketPower = 1; // Obstacles get tougher

  const panda = { x:80, y:H-62, w:48, h:48, vy:0, gravity:0.9, jumpForce:-14, onGround:true, duck:false };

  function reset(){
    if(currentUser) recordScore(Math.floor(score));
    speed = 6; score = 0; frame = 0;
    obstacles = []; clouds = []; rockets = [];
    panda.y = H-62; panda.vy = 0; panda.onGround = true;
    jumpCount = 0;
    rocketPower = 1;
    running = true;
    updateHUD();
  }

  function updateHUD(){ document.getElementById('score').textContent = Math.floor(score); }

  /* ------------------ OBSTACLES -------------------- */
  function spawnObstacle(){
    const h = 30 + Math.random()*60;
    const w = 20 + Math.random()*40;
    const toughness = rocketPower; // Higher → harder to destroy
    obstacles.push({x:W+20, y:H-40-(h-24), w, h, hp: toughness});
  }

  function spawnCloud(){ clouds.push({x:W+10, y:20+Math.random()*60, w:60+Math.random()*80}); }

  /* ------------------ ROCKETS -------------------- */
  function shootRocket(){
    if(jumpCount < 2) return; // Must earn ability
    rockets.push({x:panda.x + panda.w, y:panda.y + panda.h/2 - 4, w:16, h:6, speed:10});
  }

  document.getElementById('shoot').onclick = shootRocket;

  /* ------------------ COLLISON -------------------- */
  function rectsCollide(a,b){
    return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
  }

  /* ------------------ DRAW PANDA -------------------- */
  function drawPanda(x,y,w,h,duck){
    const headR = w*0.45;
    ctx.fillStyle = 'rgba(0,0,0,0.06)';
    ctx.beginPath(); ctx.ellipse(x+w*0.45, y+h+8, w*0.48, 8, 0, 0, Math.PI*2); ctx.fill();

    ctx.fillStyle = '#fff'; ctx.fillRect(x+(w*0.05), y+headR*0.6, w*0.9, h*0.6);
    ctx.fillStyle = '#111';
    ctx.beginPath(); ctx.arc(x+headR*0.45, y+headR*0.12, headR*0.18,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(x+w-headR*0.45, y+headR*0.12, headR*0.18,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(x+headR*0.45-6, y+headR*0.45, headR*0.16, headR*0.12,-0.2,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(x+w-headR*0.45+6, y+headR*0.45, headR*0.16, headR*0.12,0.2,0,Math.PI*2); ctx.fill();

    ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(x+w*0.45,y+headR*0.45,headR*0.6,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = '#111'; ctx.beginPath(); ctx.arc(x+headR*0.45-6,y+headR*0.45,3,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(x+w-headR*0.45+6,y+headR*0.45,3,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(x+w*0.45,y+headR*0.6,4,0,Math.PI*2); ctx.fill();

    ctx.fillStyle='#111';
    if(!duck){ ctx.fillRect(x+6,y+h-6,12,8); ctx.fillRect(x+w-18,y+h-6,12,8); }
    else ctx.fillRect(x+8,y+h-4,10,6);
  }

  /* ------------------ GAME LOOP -------------------- */
  function update(){
    if(!running) return;
    frame++;

    if(frame % 300 === 0){ speed += 0.6; rocketPower += 0.4; }

    if(frame % 140 === 0) spawnCloud();
    clouds.forEach(c => c.x -= speed*0.3);
    clouds = clouds.filter(c => c.x + c.w > -50);

    if(frame % Math.max(40,120-Math.floor(score/8)) === 0) spawnObstacle();
    obstacles.forEach(o => o.x -= speed);
    obstacles = obstacles.filter(o => o.x + o.w > -20);

    rockets.forEach(r => r.x += r.speed);
    rockets = rockets.filter(r => r.x < W+50);

    panda.vy += panda.gravity;
    panda.y += panda.vy;
    if(panda.y >= H-62){ panda.y=H-62; panda.vy=0; panda.onGround=true; }
    else panda.onGround=false;

    for(const r of rockets){
      for(const o of obstacles){
        if(rectsCollide(r,o)){
          o.hp -= 1;
          r.x = W+100;
        }
      }
    }
    obstacles = obstacles.filter(o => o.hp>0);

    const pRect = {x:panda.x, y:panda.y, w:panda.w, h:panda.h*(panda.duck?0.6:1)};
    for(const ob of obstacles){ if(rectsCollide(pRect,ob)){ running=false; recordScore(Math.floor(score)); break; }}

    score += 0.1 * speed;
    updateHUD();
  }

  function draw(){
    ctx.clearRect(0,0,W,H);
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,'#eaf6ff'); g.addColorStop(1,'#f4f8ff');
    ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

    ctx.fillStyle='rgba(255,255,255,0.95)';
    clouds.forEach(c=>{
      ctx.beginPath(); ctx.ellipse(c.x,c.y,c.w*0.7,20,0,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(c.x+20,c.y+6,c.w*0.5,14,0,0,Math.PI*2); ctx.fill();
    });

    ctx.fillStyle='#e6eef9'; ctx.fillRect(0,H-36,W,36);

    obstacles.forEach(o=>{
      ctx.fillStyle = o.hp>2?'#1f6d29':'#2d8a36';
      ctx.fillRect(o.x,o.y,o.w,o.h);
    });

    ctx.fillStyle='#444';
    rockets.forEach(r=> ctx.fillRect(r.x,r.y,r.w,r.h));

    drawPanda(panda.x,panda.y,panda.w,panda.h,panda.duck);

    if(!running){
      ctx.fillStyle='rgba(20,30,40,0.7)'; ctx.fillRect(0,0,W,H);
      ctx.fillStyle='#fff'; ctx.font='28px system-ui'; ctx.textAlign='center';
      ctx.fillText('Game Over',W/2,H/2-6);
      ctx.font='16px system-ui'; ctx.fillText('Press Restart or Space',W/2,H/2+20);
      ctx.textAlign='start';
    }
  }

  function loop(){ update(); draw(); requestAnimationFrame(loop); }

  function jump(){
    if(!running){ reset(); return; }
    if(panda.onGround){ panda.vy=panda.jumpForce; panda.onGround=false; jumpCount++; }
  }
  function duckStart(){ panda.duck=true; panda.h=34; }
  function duckEnd(){ panda.duck=false; panda.h=48; }

  window.addEventListener('keydown',e=>{
    if(e.code==='Space'||e.code==='ArrowUp'){ e.preventDefault(); jump(); }
    if(e.code==='ArrowDown'){ e.preventDefault(); duckStart(); }
    if(e.key==='r'||e.key==='R') shootRocket();
    if(e.key==='p'||e.key==='P'){ running=!running; document.getElementById('pause').textContent = running?'Pause':'Resume'; }
  });

  window.addEventListener('keyup',e=>{
    if(e.code==='ArrowDown') duckEnd();
    if(e.code==='Space' && !running) reset();
  });

  canvas.addEventListener('touchstart',e=>{ e.preventDefault(); jump(); });

  document.getElementById('restart').onclick = reset;
  document.getElementById('pause').onclick = ()=>{ running=!running; document.getElementById('pause').textContent = running?'Pause':'Resume'; };

  for(let i=0;i<3;i++) spawnCloud();
  loop();
})();
</script>
</body>
</html>
