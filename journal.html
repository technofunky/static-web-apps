<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline Journal</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.0.6/wordcloud2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        textarea, input { width: 100%; margin-bottom: 10px; }
        #entries { margin-top: 20px; }
        .entry { border-bottom: 1px solid #ddd; padding: 10px; position: relative; }
        .edit-btn, .delete-btn { cursor: pointer; padding: 5px; font-size: 14px; border: none; margin: 2px; }
        .edit-btn { background: orange; color: white; }
        .delete-btn { background: red; color: white; }
    </style>
</head>
<body>
    <h2>Offline Journal</h2>

    <textarea id="journalEntry" placeholder="Write your journal entry..."></textarea>
    <button onclick="saveEntry()">Save Entry</button>

    <h3>Search</h3>
    <input type="text" id="searchText" placeholder="Search text..." oninput="filterEntries()">
    <input type="date" id="searchDate" oninput="filterEntries()">

    <h3>Entries</h3>
    <div id="entries"></div>

    <h3>Word Cloud</h3>
    <canvas id="wordCloudCanvas" width="400" height="400"></canvas>
    <button onclick="generateWordCloud()">Generate Word Cloud</button>

    <h3>Activity Map</h3>
    <canvas id="activityChart" width="400" height="200"></canvas>
    <button onclick="generateActivityMap()">Generate Activity Map</button>

    <h3>Export Data</h3>
    <button onclick="exportData('json')">Export as JSON</button>
    <button onclick="exportData('csv')">Export as CSV</button>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            loadEntries();
        });

        function saveEntry() {
            let text = document.getElementById("journalEntry").value.trim();
            if (!text) return alert("Entry cannot be empty.");

            let entry = {
                id: Date.now(),
                text: text,
                timestamp: new Date().toISOString(),
                location: "Fetching..."
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    entry.location = `${position.coords.latitude}, ${position.coords.longitude}`;
                    storeEntry(entry);
                },
                () => {
                    storeEntry(entry);
                }
            );

            document.getElementById("journalEntry").value = "";
        }

        function storeEntry(entry) {
            let entries = JSON.parse(localStorage.getItem("journalEntries")) || [];
            entries.unshift(entry);
            localStorage.setItem("journalEntries", JSON.stringify(entries));
            loadEntries();
        }

        function loadEntries() {
            let entriesContainer = document.getElementById("entries");
            let entries = JSON.parse(localStorage.getItem("journalEntries")) || [];
            entriesContainer.innerHTML = entries.map(entry => `
                <div class="entry" id="entry-${entry.id}">
                    <strong>${new Date(entry.timestamp).toLocaleString()}</strong>
                    <p>${entry.text}</p>
                    <small>${entry.location}</small><br>
                    <button class="edit-btn" onclick="editEntry(${entry.id})">Edit</button>
                    <button class="delete-btn" onclick="deleteEntry(${entry.id})">Delete</button>
                </div>
            `).join("");
        }

        function filterEntries() {
            let searchText = document.getElementById("searchText").value.toLowerCase();
            let searchDate = document.getElementById("searchDate").value;

            let entries = JSON.parse(localStorage.getItem("journalEntries")) || [];
            let filteredEntries = entries.filter(entry => {
                let matchesText = entry.text.toLowerCase().includes(searchText);
                let matchesDate = searchDate ? entry.timestamp.startsWith(searchDate) : true;
                return matchesText && matchesDate;
            });

            let entriesContainer = document.getElementById("entries");
            entriesContainer.innerHTML = filteredEntries.map(entry => `
                <div class="entry">
                    <strong>${new Date(entry.timestamp).toLocaleString()}</strong>
                    <p>${entry.text}</p>
                    <small>${entry.location}</small><br>
                    <button class="edit-btn" onclick="editEntry(${entry.id})">Edit</button>
                    <button class="delete-btn" onclick="deleteEntry(${entry.id})">Delete</button>
                </div>
            `).join("");
        }

        function editEntry(id) {
            let entries = JSON.parse(localStorage.getItem("journalEntries")) || [];
            let entry = entries.find(e => e.id === id);
            if (!entry) return;

            let newText = prompt("Edit your entry:", entry.text);
            if (newText !== null) {
                entry.text = newText;
                localStorage.setItem("journalEntries", JSON.stringify(entries));
                loadEntries();
            }
        }

        function deleteEntry(id) {
            if (!confirm("Are you sure you want to delete this entry?")) return;

            let entries = JSON.parse(localStorage.getItem("journalEntries")) || [];
            entries = entries.filter(e => e.id !== id);
            localStorage.setItem("journalEntries", JSON.stringify(entries));
            loadEntries();
        }

        function generateWordCloud() {
            let entries = JSON.parse(localStorage.getItem("journalEntries")) || [];
            let text = entries.map(entry => entry.text).join(" ");

            let words = text.toLowerCase().match(/\b\w+\b/g) || [];
            let wordCounts = words.reduce((acc, word) => {
                acc[word] = (acc[word] || 0) + 1;
                return acc;
            }, {});

            let wordArray = Object.entries(wordCounts).map(([word, count]) => [word, count]);

            WordCloud(document.getElementById("wordCloudCanvas"), {
                list: wordArray,
                gridSize: 8,
                weightFactor: 10,
                fontFamily: "Arial",
                color: "random-dark",
                rotateRatio: 0.5,
                backgroundColor: "#f8f9fa"
            });
        }

        function generateActivityMap() {
            let entries = JSON.parse(localStorage.getItem("journalEntries")) || [];
            
            let dailyCounts = entries.reduce((acc, entry) => {
                let date = entry.timestamp.split("T")[0];
                acc[date] = (acc[date] || 0) + 1;
                return acc;
            }, {});

            let labels = Object.keys(dailyCounts).sort();
            let data = labels.map(date => dailyCounts[date]);

            let ctx = document.getElementById("activityChart").getContext("2d");
            new Chart(ctx, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Journal Entries per Day",
                        data: data,
                        backgroundColor: "rgba(54, 162, 235, 0.5)",
                        borderColor: "rgba(54, 162, 235, 1)",
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: "Date" } },
                        y: { title: { display: true, text: "Entries" }, beginAtZero: true }
                    }
                }
            });
        }

        function exportData(format) {
            let entries = JSON.parse(localStorage.getItem("journalEntries")) || [];
            let data = format === "json" ? JSON.stringify(entries, null, 2) :
                "Timestamp,Text,Location\n" + entries.map(e => `${e.timestamp},"${e.text}",${e.location}`).join("\n");

            let blob = new Blob([data], { type: format === "json" ? "application/json" : "text/csv" });
            let a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `journal_entries.${format}`;
            a.click();
        }
    </script>
</body>
</html>
