<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encrypted Offline Journal</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        textarea, input, select { width: 100%; margin-bottom: 10px; }
        .entry { border-bottom: 1px solid #ddd; padding: 10px; position: relative; }
    </style>
</head>
<body>
    <h2>ðŸ”’ Encrypted Offline Journal</h2>

    <label for="password">Set/Enter Password:</label>
    <input type="password" id="password">
    <button onclick="setPassword()">Unlock</button>
    <br><br>

    <textarea id="journalEntry" placeholder="Write your journal entry..."></textarea>
    <label for="mood">Mood:</label>
    <select id="mood">
        <option value="Low">Low</option>
        <option value="Okay" selected>Okay</option>
        <option value="High">High</option>
    </select>
    <button onclick="saveEntry()">Save Entry</button>

    <h3>Search</h3>
    <input type="text" id="searchText" placeholder="Search text..." oninput="filterEntries()">
    <input type="date" id="searchDate" oninput="filterEntries()">
    <select id="searchMood" onchange="filterEntries()">
        <option value="">All Moods</option>
        <option value="Low">Low</option>
        <option value="Okay">Okay</option>
        <option value="High">High</option>
    </select>

    <h3>Entries</h3>
    <div id="entries"></div>

    <h3>Export & Share</h3>
    <button onclick="exportData('json')">Export as JSON</button>
    <button onclick="exportData('csv')">Export as CSV</button>
    <button onclick="sendEmail()">Send via Email</button>
    <button onclick="shareOnWhatsApp()">Share on WhatsApp</button>

    <script>
        let userPassword = "";

        function setPassword() {
            userPassword = document.getElementById("password").value;
            if (!userPassword) {
                alert("Please enter a password!");
                return;
            }
            loadEntries();
        }

        function encryptData(data, password) {
            return CryptoJS.AES.encrypt(JSON.stringify(data), password).toString();
        }

        function decryptData(encryptedData, password) {
            try {
                let bytes = CryptoJS.AES.decrypt(encryptedData, password);
                return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
            } catch (error) {
                alert("Incorrect password! Cannot decrypt entries.");
                return null;
            }
        }

        function saveEntry() {
            if (!userPassword) return alert("Enter your password first!");

            let text = document.getElementById("journalEntry").value.trim();
            let mood = document.getElementById("mood").value;
            if (!text) return alert("Entry cannot be empty.");

            let entry = { id: Date.now(), text: text, mood: mood, timestamp: new Date().toISOString() };
            let entries = decryptData(localStorage.getItem("journalEntries"), userPassword) || [];

            entries.unshift(entry);
            localStorage.setItem("journalEntries", encryptData(entries, userPassword));

            document.getElementById("journalEntry").value = "";
            loadEntries();
        }

        function loadEntries() {
            if (!userPassword) return;

            let encryptedData = localStorage.getItem("journalEntries");
            if (!encryptedData) {
                document.getElementById("entries").innerHTML = "<p>No entries found.</p>";
                return;
            }

            let entries = decryptData(encryptedData, userPassword);
            if (!entries) return;

            document.getElementById("entries").innerHTML = entries.map(entry => `
                <div class="entry">
                    <strong>${new Date(entry.timestamp).toLocaleString()}</strong> - <span>${entry.mood}</span>
                    <p>${entry.text}</p>
                    <button onclick="editEntry(${entry.id})">Edit</button>
                    <button onclick="deleteEntry(${entry.id})">Delete</button>
                </div>
            `).join("");
        }

        function editEntry(id) {
            let encryptedData = localStorage.getItem("journalEntries");
            let entries = decryptData(encryptedData, userPassword);
            if (!entries) return;

            let entry = entries.find(e => e.id === id);
            if (!entry) return;

            let newText = prompt("Edit your entry:", entry.text);
            let newMood = prompt("Edit your mood (Low, Okay, High):", entry.mood);
            if (newText !== null && newMood !== null) {
                entry.text = newText;
                entry.mood = newMood;
                localStorage.setItem("journalEntries", encryptData(entries, userPassword));
                loadEntries();
            }
        }

        function deleteEntry(id) {
            if (!confirm("Are you sure?")) return;

            let encryptedData = localStorage.getItem("journalEntries");
            let entries = decryptData(encryptedData, userPassword);
            if (!entries) return;

            entries = entries.filter(e => e.id !== id);
            localStorage.setItem("journalEntries", encryptData(entries, userPassword));
            loadEntries();
        }

        function exportData(format) {
            let encryptedData = localStorage.getItem("journalEntries");
            let entries = decryptData(encryptedData, userPassword);
            if (!entries) return;

            let data = format === "json" ? JSON.stringify(entries, null, 2) :
                "Timestamp,Text,Mood\n" + entries.map(e => `${e.timestamp},"${e.text}",${e.mood}`).join("\n");

            let blob = new Blob([data], { type: format === "json" ? "application/json" : "text/csv" });
            let url = URL.createObjectURL(blob);
            let a = document.createElement("a");
            a.href = url; a.download = `journal.${format}`; a.click();
            return url;
        }

        function sendEmail() {
            let url = exportData('json');
            let subject = "My Encrypted Journal Entries";
            let body = "Download my journal entries:\n\n" + url;
            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        function shareOnWhatsApp() {
            let url = exportData('json');
            let message = `Download my journal entries:\n\n${url}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, "_blank");
        }

        function filterEntries() {
            if (!userPassword) return alert("Enter your password first!");
            let searchText = document.getElementById("searchText").value.toLowerCase();
            let searchDate = document.getElementById("searchDate").value;

            let entries = decryptData(localStorage.getItem("journalEntries"), userPassword) || [];
            let filteredEntries = entries.filter(entry => {
                let matchesText = entry.text.toLowerCase().includes(searchText);
                let matchesDate = searchDate ? entry.timestamp.startsWith(searchDate) : true;
                return matchesText && matchesDate;
            });

            let entriesContainer = document.getElementById("entries");
            entriesContainer.innerHTML = filteredEntries.map(entry => `
                <div class="entry">
                    <strong>${new Date(entry.timestamp).toLocaleString()}</strong>
                    <p>${entry.text}</p>
                    <small>${entry.location}</small><br>
                    <button class="edit-btn" onclick="editEntry(${entry.id})">Edit</button>
                    <button class="delete-btn" onclick="deleteEntry(${entry.id})">Delete</button>
                </div>
            `).join("");
        }
    </script>
</body>
</html>
